{% extends base_template %} {% block content %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Management System</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/css/ui.jqgrid.css"
    />

    <style>
      .ui-jqgrid {
        font-size: 14px;
      }
      .ui-jqgrid .ui-jqgrid-htable th {
        padding: 0.5rem;
      }
      .ui-jqgrid .ui-jqgrid-btable tr.jqgrow td {
        padding: 0.4rem;
        vertical-align: middle;
      }
      .ui-jqgrid-titlebar {
        background-color: #0d6efd;
        color: white;
        border-radius: 0.25rem 0.25rem 0 0;
      }
      .action-btn-group .btn {
        margin: 0 2px;
      }
      .container {
        max-width: 95%;
      }
      .filter-form {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .form-control, .form-select {
        border-radius: 0.25rem;
      }
      .modal-header {
        border-bottom: none;
      }
      .modal-footer {
        border-top: 1px solid #dee2e6;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Task Management</h1>
        {% if user.is_authenticated and user.user_type == 'admin' %}
            <button
              type="button"
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addTaskModal">
              <i class="bi bi-plus-circle me-1"></i> Create Task
            </button>
        {% endif %}
      </div>

      <div class="filter-form">
        <form id="filter-form" class="row g-3 align-items-center">
            <div class="col-md-5">
              <input
                type="text"
                name="search"
                class="form-control"
                placeholder="Search by Task, Assignee, or Email"
                value="{{ request.GET.search }}"
              />
            </div>
            <div class="col-md-2">
              <select name="status" class="form-select">
                <option value="">All Statuses</option>
                {% for choice in status_choices %}
                  <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <select name="priority" class="form-select">
                <option value="">All Priorities</option>
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
              </select>
            </div>
            <div class="col-md-3 text-end">
              <button type="submit" class="btn btn-success"><i class="bi bi-filter"></i> Filter</button>
              <a href="{% url 'tasks:task_list' %}" class="btn btn-secondary"><i class="bi bi-arrow-clockwise"></i> Clear</a>
            </div>
        </form>
      </div>

      <table id="jqGrid"></table>
      <div id="jqGridPager"></div>
    </div>

    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-plus-circle-fill me-2"></i>Create New Task</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="addTaskForm" method="POST" action="{% url 'tasks:task_create' %}" enctype="multipart/form-data" novalidate>
                  {% csrf_token %}
                  <div id="add-form-errors" class="alert alert-danger d-none"></div>
                  
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="id_task_name" class="form-label">Task Name</label>
                      {{ form.task_name }}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="id_assigned_to" class="form-label">Assigned To (Employee)</label>
                      {{ form.assigned_to }}
                    </div>
                  </div>
    
                  <div class="mb-3">
                    <label for="id_description" class="form-label">Description</label>
                    {{ form.description }}
                  </div>
    
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="id_email" class="form-label">Email</label>
                      {{ form.email }}
                    </div>
                     <div class="col-md-6 mb-3">
                      <label for="id_due_date" class="form-label">Due Date</label>
                      {{ form.due_date }}
                    </div>
                  </div>
    
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="id_priority" class="form-label">Priority</label>
                      {{ form.priority }}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="id_status" class="form-label">Status</label>
                      {{ form.status }}
                    </div>
                  </div>
                  
                  <div class="mb-3">
                      <label for="id_comment" class="form-label">Comments</label>
                      {{ form.comment }}
                  </div>
                  
                  <div class="mb-3">
                      <label for="id_upload" class="form-label">Upload File</label>
                      {{ form.upload }}
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="saveTaskBtn" class="btn btn-primary">Create Task</button>
              </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div id="edit-spinner" class="text-center p-5">
                  <div class="spinner-border text-warning" role="status"></div>
                </div>
                <form id="editTaskForm" method="POST" class="d-none" enctype="multipart/form-data" novalidate>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="updateTaskBtn" class="btn btn-warning">Save Changes</button>
              </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-trash-fill me-2"></i>Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p>Are you sure you want to delete this task?</p>
                <p><strong><span id="delete-task-name"></span></strong></p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Yes, Delete</button>
              </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="viewTaskModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title" id="viewTaskModalTitle"><i class="bi bi-eye-fill me-2"></i>Task Details</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="viewTaskModalBody">
             </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" id="saveUpdateBtn" class="btn btn-success d-none">Submit Update</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/i18n/grid.locale-en.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/jquery.jqGrid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="text/javascript">
      $(document).ready(function () {
        const taskDetailUrl = "{% url 'tasks:task_detail' 0 %}";
        const taskUpdateUrl = "{% url 'tasks:task_update' 0 %}";
        const taskDeleteUrl = "{% url 'tasks:task_delete' 0 %}";
        const statusUpdateUrl = "{% url 'tasks:update_task_status' 0 %}";
        const csrfToken = "{{ csrf_token }}";
        
        const currentUserType = "{{ user.user_type|default:'employee' }}";
        const isAdmin = currentUserType === 'admin' || currentUserType === '1';

        function actionButtonFormatter(cellvalue, options, rowObject) {
            const taskId = options.rowId;
            let buttons = '';
            
            if (isAdmin) {
                // Admin buttons
                buttons += `<button type="button" class="btn btn-sm btn-info view-btn" data-task-id="${taskId}" title="View"><i class="bi bi-eye"></i></button> `;
                buttons += `<button type="button" class="btn btn-sm btn-warning edit-btn" data-task-id="${taskId}" title="Edit"><i class="bi bi-pencil"></i></button> `;
                buttons += `<button type="button" class="btn btn-sm btn-danger delete-btn" data-task-id="${taskId}" title="Delete"><i class="bi bi-trash"></i></button>`;
            } else {
                buttons += `<button type="button" class="btn btn-sm btn-info view-btn" data-task-id="${taskId}" title="View"><i class="bi bi-eye"></i></button> `;
                // Employee button
                buttons += `<button type="button" class="btn btn-sm btn-success update-btn" data-task-id="${taskId}" title="Update Status"><i class="bi bi-check2-square"></i> Update</button>`;
            }
            
            return `<div class="action-btn-group">${buttons}</div>`;
        }

        var grid = $("#jqGrid");
        grid.jqGrid({
            url: "{% url 'tasks:task_jqgrid' %}",
            mtype: "GET",
            datatype: "json",
            colModel: [
              { label: "Task Name", name: "task_name", width: 150 },
              { label: "Assigned To", name: "assigned_to", width: 100 },
              { label: "Email", name: "email", width: 150 },
              { label: "Priority", name: "priority", width: 80, align: "center" },
              { label: "Status", name: "status", width: 100, align: "center" },
              { label: "Due Date", name: "due_date", width: 90 },
              {
                label: "Actions", name: "actions", width: 120, align: "center",
                sortable: false, search: false, formatter: actionButtonFormatter,
              },
            ],
            viewrecords: true,
            height: "auto",
            autowidth: true,
            rowNum: 10,
            pager: "#jqGridPager",
            caption: "Task List",
            loadonce: false,
            rownumbers: true,
            jsonReader: {
                root: "rows",
                page: "page",
                total: "total",
                records: "records",
                repeatitems: false,
                id: "id"
            },
          })
          .jqGrid(
            "navGrid", "#jqGridPager",
            { edit: false, add: false, del: false, search: true, refresh: true },
            {}, {}, {}, { closeOnEscape: true, multipleSearch: true, closeAfterSearch: true }
          );

        // Filter Form Logic
        $("#filter-form").on("submit", function (e) {
          e.preventDefault();
          var postData = grid.jqGrid("getGridParam", "postData");
          $.extend(postData, {
            search: $("input[name='search']").val(),
            status: $("select[name='status']").val(),
            priority: $("select[name='priority']").val(),
          });
          grid.jqGrid("setGridParam", { search: true });
          grid.trigger("reloadGrid", [{ page: 1 }]);
        });
        
        // Event Delegation for Action Buttons
        grid.on("click", ".view-btn, .edit-btn, .delete-btn, .update-btn", function () {
            var taskId = $(this).data("task-id");
            if ($(this).hasClass("view-btn")) handleView(taskId);
            else if ($(this).hasClass("edit-btn")) handleEdit(taskId);
            else if ($(this).hasClass("delete-btn")) handleDelete(taskId);
            else if ($(this).hasClass("update-btn")) handleUpdate(taskId);
        });

        const viewModal = new bootstrap.Modal(document.getElementById("viewTaskModal"));
        const editModal = new bootstrap.Modal(document.getElementById("editTaskModal"));
        const deleteModal = new bootstrap.Modal(document.getElementById("deleteTaskModal"));
        const addTaskModal = new bootstrap.Modal(document.getElementById("addTaskModal"));

        function handleUpdate(taskId) {
            $("#viewTaskModalTitle").html('<i class="bi bi-check2-square me-2"></i>Update Task Status');
            $("#viewTaskModalBody").html('<div class="text-center p-5"><div class="spinner-border text-success" role="status"></div></div>');
            viewModal.show();
            
            $.ajax({
                url: taskDetailUrl.replace("0", taskId),
                headers: { "X-Requested-With": "XMLHttpRequest" },
                success: function (data) {
                    if (data.success) {
                        const task = data.task;
                        const statusChoices = data.status_choices;

                        // Build status dropdown
                        let statusDropdown = `<select id="update_status" class="form-select">`;
                        statusChoices.forEach(choice => {
                            const selected = choice[0] === task.status ? "selected" : "";
                            statusDropdown += `<option value="${choice[0]}" ${selected}>${choice[1]}</option>`;
                        });
                        statusDropdown += `</select>`;
                        
                        // Set up modal content for update
                        $("#viewTaskModalBody").html(`
                            <h4 class="mb-3">${task.task_name}</h4>
                            <div class="mb-3">
                                <label for="update_status" class="form-label"><strong>Status</strong></label>
                                ${statusDropdown}
                            </div>
                            <div class="mb-3">
                                <label for="update_comment" class="form-label"><strong>Comment</strong></label>
                                <textarea id="update_comment" class="form-control" rows="4" placeholder="Add a comment..."></textarea>
                            </div>
                        `);

                        // Show and configure the submit button
                        $("#saveUpdateBtn").data("task-id", taskId).removeClass('d-none');
                    }
                },
                error: () => $("#viewTaskModalBody").html('<div class="alert alert-danger">Could not load task details.</div>')
            });
        }
        
        // Admin View Function (remains mostly the same)
        function handleView(taskId) {
            $("#viewTaskModalTitle").html('<i class="bi bi-eye-fill me-2"></i>Task Details');
            $("#viewTaskModalBody").html('<div class="text-center p-5"><div class="spinner-border text-info" role="status"></div></div>');
            $("#saveUpdateBtn").addClass('d-none'); // Hide update button for admin view
            viewModal.show();
            $.ajax({
                url: taskDetailUrl.replace("0", taskId),
                headers: { "X-Requested-With": "XMLHttpRequest" },
                success: function (data) {
                    if(data.success) {
                        const task = data.task;
                        let fileLink = task.upload ? `<a href="${task.upload}" target="_blank">View Attached File</a>` : 'No file attached';
                         $("#viewTaskModalBody").html(`
                            <h4>${task.task_name}</h4>
                            <p class="text-muted">${task.description || "No description."}</p><hr>
                            <div class="row">
                                <div class="col-md-6"><p><strong>Assigned To:</strong> ${task.assigned_to}</p></div>
                                <div class="col-md-6"><p><strong>Email:</strong> ${task.email}</p></div>
                                <div class="col-md-6"><p><strong>Priority:</strong> <span class="badge bg-${task.priority_class}">${task.priority}</span></p></div>
                                <div class="col-md-6"><p><strong>Due Date:</strong> ${task.due_date}</p></div>
                                <div class="col-md-6"><p><strong>Status:</strong><span class="badge bg-secondary ms-2">${task.status}</span></p></div>
                                <div class="col-md-12 mt-2"><p><strong>Comments:</strong> ${task.comment || 'N/A'}</p></div>
                                <div class="col-md-12 mt-2"><p><strong>Attachment:</strong> ${fileLink}</p></div>
                            </div>`);
                    }
                }
            });
        }

        // Click handler for the new "Submit Update" button
        $("#saveUpdateBtn").on("click", function () {
            const taskId = $(this).data("task-id");
            const newStatus = $("#update_status").val();
            const comment = $("#update_comment").val(); 

            $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...');

            $.ajax({
                url: statusUpdateUrl.replace("0", taskId),
                method: "POST",
                // Send status and comment data to the backend
                data: {
                    status: newStatus,
                    comment: comment,
                    csrfmiddlewaretoken: csrfToken,
                },
                success: data => {
                    if (data.success) {
                        viewModal.hide();
                        grid.trigger("reloadGrid");
                    } else {
                        alert("Failed to update status: " + (data.error || 'Unknown error'));
                    }
                },
                error: () => alert("An error occurred while updating the task."),
                complete: () => {
                    // Re-enable the button
                    $("#saveUpdateBtn").prop('disabled', false).html('Submit Update');
                }
            });
        });
        
        // Handle Edit and Delete functions (Your existing code)
        function handleEdit(taskId) {
          $("#edit-spinner").removeClass("d-none");
          $("#editTaskForm").addClass("d-none").html('');
          editModal.show();

          $.get("{% url 'tasks:task_update' 0 %}".replace('0', taskId), function(data) {});

          $.ajax({
            url: taskDetailUrl.replace("0", taskId),
            success: function (data) {
              if (data.success) {
                const task = data.task;
                const formHtml = `
                    {% for field in form %}{% endfor %}
                    <div id="edit-form-errors" class="alert alert-danger d-none"></div>
                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Task Name</label><input type="text" name="task_name" class="form-control" value="${task.task_name}"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Assigned To</label><input type="text" name="assigned_to" class="form-control" value="${task.assigned_to}" readonly></div>
                    </div>
                     <div class="mb-3"><label class="form-label">Description</label><textarea name="description" class="form-control" rows="3">${task.description}</textarea></div>
                     <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Email</label><input type="email" name="email" class="form-control" value="${task.email}"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Due Date</label><input type="date" name="due_date" class="form-control" value="${task.due_date}"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Priority</label><select name="priority" class="form-select"></select></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Status</label><select name="status" class="form-select"></select></div>
                    </div>
                    <div class="mb-3"><label class="form-label">Comment</label><textarea name="comment" class="form-control" rows="2">${task.comment || ''}</textarea></div>
                    <div class="mb-3"><label class="form-label">Upload New File</label><input type="file" name="upload" class="form-control"></div>
                `;
                $("#editTaskForm").html(formHtml);
                
                populateSelect('priority', ['Low', 'Medium', 'High'], task.priority);
                populateSelect('status', ['Pending', 'In Progress', 'Completed'], task.status);

                $("#editTaskForm").attr("action", taskUpdateUrl.replace("0", taskId));
                $("#edit-spinner").addClass("d-none");
                $("#editTaskForm").removeClass("d-none");
              }
            }
          });
        }
        
        function populateSelect(name, options, selectedValue) {
            const select = $(`#editTaskForm [name=${name}]`);
            options.forEach(opt => select.append(`<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`));
        }
        
        function handleDelete(taskId) {
          $("#delete-task-name").text("this task");
          deleteModal.show();
          $("#confirmDeleteBtn").data("task-id", taskId);
          $.get(taskDetailUrl.replace("0", taskId), data => {
              if(data.success) $("#delete-task-name").text(`"${data.task.task_name}"`);
          });
        }

        $("#updateTaskBtn").on("click", function () {
          var form = $("#editTaskForm");
          var formData = new FormData(form[0]);
          $.ajax({
            url: form.attr("action"),
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
              if (data.success) {
                editModal.hide();
                grid.trigger("reloadGrid");
              } else {
                let errorHtml = '<ul>';
                for (const field in data.errors) {
                  errorHtml += `<li>${field}: ${data.errors[field][0]}</li>`;
                }
                errorHtml += '</ul>';
                $("#edit-form-errors").html(errorHtml).removeClass("d-none");
              }
            },
            error: () => $("#edit-form-errors").html("An unexpected error occurred.").removeClass("d-none")
          });
        });

        $("#confirmDeleteBtn").on("click", function () {
          var taskId = $(this).data("task-id");
          $.ajax({
            url: taskDeleteUrl.replace("0", taskId),
            method: "POST",
            headers: { "X-CSRFToken": csrfToken },
            success: (data) => {
              if (data.success) {
                deleteModal.hide();
                grid.trigger("reloadGrid");
              }
            },
          });
        });

        $("#saveTaskBtn").on("click", function () {
          var form = $("#addTaskForm");
          var formData = new FormData(form[0]);

          $.ajax({
            url: form.attr("action"),
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            headers: { "X-Requested-With": "XMLHttpRequest" },
            success: function (data) {
              if (data.success) {
                addTaskModal.hide();
                grid.trigger("reloadGrid");
                form.trigger("reset");
                $("#add-form-errors").addClass('d-none').html('');
              } else {
                let errorHtml = '<ul>';
                for (const field in data.errors) {
                  errorHtml += `<li>${field}: ${data.errors[field][0]}</li>`;
                }
                errorHtml += '</ul>';
                $("#add-form-errors").html(errorHtml).removeClass("d-none");
              }
            },
            error: () => alert('An unexpected error occurred.')
          });
        });
      });
    </script>
  </body>
</html>

{% endblock %}