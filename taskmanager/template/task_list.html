{% extends base_template %} 

{% block title %}{% if user.user_type == 'employee' or user.user_type == '2' %}Employee Panel - Tasks{% else %}Admin Panel - Task Management{% endif %}{% endblock %}

{% block content %}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% if user.user_type == 'employee' or user.user_type == '2' %}Employee Panel - Tasks{% else %}Admin Panel - Task Management{% endif %}</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/css/ui.jqgrid.css"
    />
    <!-- üìÖ DATEPICKER CSS: Bootstrap Datepicker for custom date formats -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"
    />

    <style>
      .ui-jqgrid {
        font-size: 14px;
      }
      .ui-jqgrid .ui-jqgrid-htable th {
        padding: 0.5rem;
      }
      .ui-jqgrid .ui-jqgrid-btable tr.jqgrow td {
        padding: 0.4rem;
        vertical-align: middle;
      }
      .ui-jqgrid-titlebar {
        background-color: #0d6efd;
        color: white;
        border-radius: 0.25rem 0.25rem 0 0;
      }
      .action-btn-group .btn {
        margin: 0 2px;
      }
      .container {
        max-width: 95%;
      }
      .filter-form {
        background-color: #f8f9fa;
        padding: 1.5rem;
        border-radius: 0.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      .form-control, .form-select {
        border-radius: 0.25rem;
      }
      .modal-header {
        border-bottom: none;
      }
      .modal-footer {
        border-top: 1px solid #dee2e6;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Task Management</h1>
        {% if user.is_authenticated and user.user_type == 'admin' %}
            <button
              type="button"
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#addTaskModal">
              <i class="bi bi-plus-circle me-1"></i> Create Task
            </button>
        {% endif %}
      </div>

      <div class="filter-form">
        <form id="filter-form" class="row g-3 align-items-center">
            <div class="col-md-5">
              <input
                type="text"
                name="search"
                class="form-control"
                placeholder="Search by Task, Assignee, or Email"
                value="{{ request.GET.search }}"
              />
            </div>
            <div class="col-md-2">
              <select name="status" class="form-select">
                <option value="">All Statuses</option>
                {% for choice in status_choices %}
                  <option value="{{ choice.0 }}">{{ choice.1 }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2">
              <select name="priority" class="form-select">
                <option value="">All Priorities</option>
                <option value="Low">Low</option>
                <option value="Medium">Medium</option>
                <option value="High">High</option>
              </select>
            </div>
            <div class="col-md-3 text-end">
              <button type="submit" class="btn btn-success"><i class="bi bi-filter"></i> Filter</button>
              <a href="{% url 'tasks:task_list' %}" class="btn btn-secondary"><i class="bi bi-arrow-clockwise"></i> Clear</a>
            </div>
        </form>
      </div>

      <table id="jqGrid"></table>
      <div id="jqGridPager"></div>
    </div>
<!-- add task modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-plus-circle-fill me-2"></i>Create New Task</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="addTaskForm" method="POST" action="{% url 'tasks:task_create' %}" enctype="multipart/form-data" novalidate>
                  {% csrf_token %}
                  <div id="add-form-errors" class="alert alert-danger d-none"></div>
                  
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="id_task_name" class="form-label">Task Name</label>
                      {{ form.task_name }}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="id_assigned_to" class="form-label">Assigned To (Employee)</label>
                      {{ form.assigned_to }}
                    </div>
                  </div>
    
                  <div class="mb-3">
                    <label for="id_description" class="form-label">Description</label>
                    {{ form.description }}
                  </div>
    
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="id_email" class="form-label">Email</label>
                      {{ form.email }}
                    </div>
                     <div class="col-md-6 mb-3">
                      <label for="id_due_date" class="form-label">Due Date</label>
                      {{ form.due_date }}
                    </div>
                  </div>
    
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label for="id_priority" class="form-label">Priority</label>
                      {{ form.priority }}
                    </div>
                    <div class="col-md-6 mb-3">
                      <label for="id_status" class="form-label">Status</label>
                      {{ form.status }}
                    </div>
                  </div>
                  
                  <div class="mb-3">
                      <label for="id_comment" class="form-label">Comments</label>
                      {{ form.comment }}
                  </div>
                  
                  <div class="mb-3">
                      <label for="id_upload" class="form-label">Upload File</label>
                      {{ form.upload }}
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="saveTaskBtn" class="btn btn-primary">Create Task</button>
              </div>
            </div>
        </div>
    </div>
    <!-- Edit Task Modal -->
    <div class="modal fade" id="editTaskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>Edit Task</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div id="edit-spinner" class="text-center p-5">
                  <div class="spinner-border text-warning" role="status"></div>
                </div>
                <form id="editTaskForm" method="POST" class="d-none" enctype="multipart/form-data" novalidate>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="updateTaskBtn" class="btn btn-warning">Save Changes</button>
              </div>
            </div>
        </div>
    </div>
    <!-- delete task modal -->
    <div class="modal fade" id="deleteTaskModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="bi bi-trash-fill me-2"></i>Confirm Deletion</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <p>Are you sure you want to delete this task?</p>
                <p><strong><span id="delete-task-name"></span></strong></p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" id="confirmDeleteBtn" class="btn btn-danger">Yes, Delete</button>
              </div>
            </div>
        </div>
    </div>

    <!-- view task modal -->
    <div class="modal fade" id="viewTaskModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-info text-white">
            <h5 class="modal-title" id="viewTaskModalTitle"><i class="bi bi-eye-fill me-2"></i>Task Details</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="viewTaskModalBody">
             </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" id="saveUpdateBtn" class="btn btn-success d-none">Submit Update</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/i18n/grid.locale-en.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqgrid/4.6.0/js/jquery.jqGrid.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- üìÖ DATEPICKER JS: Bootstrap Datepicker for custom date formats -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

    <script type="text/javascript">
      $(document).ready(function () {
        const taskDetailUrl = "{% url 'tasks:task_detail' 0 %}";
        const taskUpdateUrl = "{% url 'tasks:task_update' 0 %}";
        const taskDeleteUrl = "{% url 'tasks:task_delete' 0 %}";
        const statusUpdateUrl = "{% url 'tasks:update_task_status' 0 %}";
        const csrfToken = "{{ csrf_token }}";
        
        // Set minimum date for due date fields to today
        const today = new Date().toISOString().split('T')[0];
        $('#id_due_date').attr('min', today);

      // ‚ö°due_date / due date  format for create task modal EASY FORMAT CHANGE: yy-mm-dd, dd-mm-yy, mm/dd/yy, etc.
        const DATE_FORMAT = 'dd-mm-yy';  
        
        let datepickerInitialized = false;

        function initializeDatepicker() {
            // Only initialize if not already initialized or if explicitly needed
            if (!datepickerInitialized || $('.datepicker-custom').data('datepicker') === undefined) {
                // Destroy existing datepicker instances to prevent conflicts
                $('.datepicker-custom').datepicker('destroy');

                // Initialize fresh datepicker
                $('.datepicker-custom').datepicker({
                    format: DATE_FORMAT,
                    startDate: 'today',
                    autoclose: true,
                    todayHighlight: true,
                    orientation: 'bottom',
                    container: 'body',
                    // Prevent form reset on date selection
                    forceParse: false
                }).on('changeDate', function(e) {
                    // Trigger change event for form validation
                    $(this).trigger('change');
                }).on('show', function(e) {
                    // Prevent any form resets when datepicker shows
                    e.stopPropagation();
                });

                datepickerInitialized = true;
            }
        }

        // Initialize datepicker on page load
        initializeDatepicker();

        // üìÖ MODAL EVENT HANDLERS: Initialize datepicker only when modal is fully shown
        $('#addTaskModal').on('shown.bs.modal', function() {
            // Only reinitialize if datepicker is not working
            if ($('#id_due_date').data('datepicker') === undefined) {
                setTimeout(function() {
                    initializeDatepicker();
                }, 150);
            }
        });

        $('#editTaskModal').on('shown.bs.modal', function() {
            // Only reinitialize if datepicker is not working
            if ($('#id_due_date').data('datepicker') === undefined) {
                setTimeout(function() {
                    initializeDatepicker();
                }, 150);
            }
        });
        
        const currentUserType = "{{ user.user_type|default:'employee' }}";
        const isAdmin = currentUserType === 'admin' || currentUserType === '1';

        function actionButtonFormatter(cellvalue, options, rowObject) {
            const taskId = options.rowId;
            let buttons = '';
            
            if (isAdmin) {
                // Admin buttons
                buttons += `<button type="button" class="btn btn-sm btn-info view-btn" data-task-id="${taskId}" title="View"><i class="bi bi-eye"></i></button> `;
                buttons += `<button type="button" class="btn btn-sm btn-warning edit-btn" data-task-id="${taskId}" title="Edit"><i class="bi bi-pencil"></i></button> `;
                buttons += `<button type="button" class="btn btn-sm btn-danger delete-btn" data-task-id="${taskId}" title="Delete"><i class="bi bi-trash"></i></button>`;
            } else {
                buttons += `<button type="button" class="btn btn-sm btn-info view-btn" data-task-id="${taskId}" title="View"><i class="bi bi-eye"></i></button> `;
                // Employee button
                buttons += `<button type="button" class="btn btn-sm btn-success update-btn" data-task-id="${taskId}" title="Update Status"><i class="bi bi-check2-square"></i> Update</button>`;
            }
            
            return `<div class="action-btn-group">${buttons}</div>`;
        }

        var grid = $("#jqGrid");
        <!-- #JQGrid formation start here  -->
        grid.jqGrid({
            url: "{% url 'tasks:task_jqgrid' %}",
            mtype: "GET",
            datatype: "json",
            colModel: [
              { label: "Task Name", name: "task_name", width: 150 },
              { label: "Assigned To", name: "assigned_to", width: 100 },
              { label: "Email", name: "email", width: 150 },
              { label: "Priority", name: "priority", width: 80, align: "center" },
              { label: "Status", name: "status", width: 100, align: "center" },
              { label: "Due Date", name: "due_date", width: 90 },
              {
                label: "Actions", name: "actions", width: 120, align: "center",
                sortable: false, search: false, formatter: actionButtonFormatter,
              },
            ],
            viewrecords: true,
            height: "auto",
            autowidth: true,
            rowNum: 10,
            pager: "#jqGridPager",
            caption: "Task List",
            loadonce: false,
            rownumbers: true,
            jsonReader: {
                root: "rows",
                page: "page",
                total: "total",
                records: "records",
                repeatitems: false,
                id: "id"
            },
          })
          .jqGrid(
            "navGrid", "#jqGridPager",
            { edit: false, add: false, del: false, search: true, refresh: true },
            {}, {}, {}, { closeOnEscape: true, multipleSearch: true, closeAfterSearch: true }
          );

        // Filter Form Logic
        $("#filter-form").on("submit", function (e) {
          e.preventDefault();
          var postData = grid.jqGrid("getGridParam", "postData");
          $.extend(postData, {
            search: $("input[name='search']").val(),
            status: $("select[name='status']").val(),
            priority: $("select[name='priority']").val(),
          });
          grid.jqGrid("setGridParam", { search: true });
          grid.trigger("reloadGrid", [{ page: 1 }]);
        });
        
        // Event Delegation for Action Buttons
        grid.on("click", ".view-btn, .edit-btn, .delete-btn, .update-btn", function () {
            var taskId = $(this).data("task-id");
            if ($(this).hasClass("view-btn")) handleView(taskId);
            else if ($(this).hasClass("edit-btn")) handleEdit(taskId);
            else if ($(this).hasClass("delete-btn")) handleDelete(taskId);
            else if ($(this).hasClass("update-btn")) handleUpdate(taskId);
        });

        const viewModal = new bootstrap.Modal(document.getElementById("viewTaskModal"));
        const editModal = new bootstrap.Modal(document.getElementById("editTaskModal"));
        const deleteModal = new bootstrap.Modal(document.getElementById("deleteTaskModal"));
        const addTaskModal = new bootstrap.Modal(document.getElementById("addTaskModal"));

        // Reset form when modal is opened (but preserve user input during interactions)
        let isModalOpen = false;
        $('#addTaskModal').on('show.bs.modal', function () {
            if (!isModalOpen) {
                // Only reset on initial modal open, not on field interactions
                $('#addTaskForm')[0].reset();
                $('#id_email').prop('readonly', false);
                $('#add-form-errors').addClass('d-none').html('');
                isModalOpen = true;
            }
        });

        // Clean up when modal is fully hidden
        $('#addTaskModal').on('hidden.bs.modal', function () {
            // Remove any leftover backdrop and ensure body is clean
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open').css('overflow', '').css('padding-right', '');

            // Reset form completely
            $('#addTaskForm')[0].reset();
            $('#add-form-errors').addClass('d-none').html('');

            // Reset the modal state flag
            isModalOpen = false;
            datepickerInitialized = false; // Allow fresh initialization next time
        });

        function handleUpdate(taskId) {
            $("#viewTaskModalTitle").html('<i class="bi bi-check2-square me-2"></i>Update Task Status');
            $("#viewTaskModalBody").html('<div class="text-center p-5"><div class="spinner-border text-success" role="status"></div></div>');
            viewModal.show();
            
            $.ajax({
                url: taskDetailUrl.replace("0", taskId),
                headers: { "X-Requested-With": "XMLHttpRequest" },
                success: function (data) {
                    if (data.success) {
                        const task = data.task;
                        const statusChoices = data.status_choices;

                        // Build status dropdown
                        let statusDropdown = `<select id="update_status" class="form-select">`;
                        statusChoices.forEach(choice => {
                            const selected = choice[0] === task.status ? "selected" : "";
                            statusDropdown += `<option value="${choice[0]}" ${selected}>${choice[1]}</option>`;
                        });
                        statusDropdown += `</select>`;
                        
                        // Set up modal content for update
                        $("#viewTaskModalBody").html(`
                            <h4 class="mb-3">${task.task_name}</h4>
                            <div class="mb-3">
                                <label for="update_status" class="form-label"><strong>Status</strong></label>
                                ${statusDropdown}
                            </div>
                            <div class="mb-3">
                                <label for="update_comment" class="form-label"><strong>Comment</strong></label>
                                <textarea id="update_comment" class="form-control" rows="4" placeholder="Add a comment..."></textarea>
                            </div>
                        `);

                        // Show and configure the submit button
                        $("#saveUpdateBtn").data("task-id", taskId).removeClass('d-none');
                    }
                },
                error: () => $("#viewTaskModalBody").html('<div class="alert alert-danger">Could not load task details.</div>')
            });
        }
        
        // Admin View Function (remains mostly the same)
        function handleView(taskId) {
            $("#viewTaskModalTitle").html('<i class="bi bi-eye-fill me-2"></i>Task Details');
            $("#viewTaskModalBody").html('<div class="text-center p-5"><div class="spinner-border text-info" role="status"></div></div>');
            $("#saveUpdateBtn").addClass('d-none'); // Hide update button for admin view
            viewModal.show();
            $.ajax({
                url: taskDetailUrl.replace("0", taskId),
                headers: { "X-Requested-With": "XMLHttpRequest" },
                success: function (data) {
                    if(data.success) {
                        const task = data.task;
                        let fileLink = task.upload ? `<a href="${task.upload}" target="_blank">View Attached File</a>` : 'No file attached';
                         $("#viewTaskModalBody").html(`
                            <h4>${task.task_name}</h4>
                            <!-- task create view modal JavaScript code logic -->
                            <p class="text-muted">${task.description || "No description."}</p><hr>
                            <div class="row">
                                <div class="col-md-6"><p><strong>Assigned To:</strong> ${task.assigned_to}</p></div>
                                <div class="col-md-6"><p><strong>Email:</strong> ${task.email}</p></div>
                                <div class="col-md-6"><p><strong>Priority:</strong> <span class="badge bg-${task.priority_class}">${task.priority}</span></p></div>
                                <div class="col-md-6"><p><strong>Due Date:</strong> ${task.due_date}</p></div>
                                <div class="col-md-6"><p><strong>Status:</strong><span class="badge bg-secondary ms-2">${task.status}</span></p></div>
                                <div class="col-md-12 mt-2"><p><strong>Comments:</strong> ${task.comment || 'N/A'}</p></div>
                                <div class="col-md-12 mt-2"><p><strong>Attachment:</strong> ${fileLink}</p></div>
                            </div>`);
                    }
                }
            });
        }

        // Click handler for the new "Submit Update" button
        $("#saveUpdateBtn").on("click", function () {
            const taskId = $(this).data("task-id");
            const newStatus = $("#update_status").val();
            const comment = $("#update_comment").val(); 

            $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...');

            $.ajax({
                url: statusUpdateUrl.replace("0", taskId),
                method: "POST",
                // Send status and comment data to the backend
                data: {
                    status: newStatus,
                    comment: comment,
                    csrfmiddlewaretoken: csrfToken,
                },
                success: data => {
                    if (data.success) {
                        viewModal.hide();
                        grid.trigger("reloadGrid");
                    } else {
                        alert("Failed to update status: " + (data.error || 'Unknown error'));
                    }
                },
                error: () => alert("An error occurred while updating the task."),
                complete: () => {
                    // Re-enable the button
                    $("#saveUpdateBtn").prop('disabled', false).html('Submit Update');
                }
            });
        });
        
        // Handle Edit and Delete functions (Your existing code)
        function handleEdit(taskId) {
          $("#edit-spinner").removeClass("d-none");
          $("#editTaskForm").addClass("d-none").html('');
          editModal.show();

          $.get("{% url 'tasks:task_update' 0 %}".replace('0', taskId), function(data) {});

          $.ajax({
            url: taskDetailUrl.replace("0", taskId),
            success: function (data) {
              if (data.success) {
                const task = data.task;
                console.log('üîç Edit Modal - Task due_date from server:', task.due_date);
                
                const formHtml = `
                    {% for field in form %}{% endfor %}
                    <div id="edit-form-errors" class="alert alert-danger d-none"></div>
                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Task Name</label><input type="text" name="task_name" class="form-control" value="${task.task_name}"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Assigned To</label><input type="text" name="assigned_to" class="form-control" value="${task.assigned_to}" readonly></div>
                    </div>
                     <div class="mb-3"><label class="form-label">Description</label><textarea name="description" class="form-control" rows="3">${task.description}</textarea></div>
                     <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Email</label><input type="email" name="email" class="form-control" value="${task.email}"></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Due Date</label><input type="date" name="due_date" class="form-control" value="${task.due_date}"></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label class="form-label">Priority</label><select name="priority" class="form-select"></select></div>
                        <div class="col-md-6 mb-3"><label class="form-label">Status</label><select name="status" class="form-select"></select></div>
                    </div>
                    <div class="mb-3"><label class="form-label">Comment</label><textarea name="comment" class="form-control" rows="2">${task.comment || ''}</textarea></div>
                    <div class="mb-3"><label class="form-label">Upload New File</label><input type="file" name="upload" class="form-control"></div>
                `;
                $("#editTaskForm").html(formHtml);
                
                populateSelect('priority', ['Low', 'Medium', 'High'], task.priority);
                populateSelect('status', ['Pending', 'In Progress', 'Completed'], task.status);

                $("#editTaskForm").attr("action", taskUpdateUrl.replace("0", taskId));
                $("#edit-spinner").addClass("d-none");
                $("#editTaskForm").removeClass("d-none");
                
                // Set minimum date for edit form due date field
                const today = new Date().toISOString().split('T')[0];
                $('#editTaskForm [name="due_date"]').attr('min', today);
              }
            }
          });
        }
        
        function populateSelect(name, options, selectedValue) {
            const select = $(`#editTaskForm [name=${name}]`);
            options.forEach(opt => select.append(`<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`));
        }
        
        function handleDelete(taskId) {
          $("#delete-task-name").text("this task");
          deleteModal.show();
          $("#confirmDeleteBtn").data("task-id", taskId);
          $.get(taskDetailUrl.replace("0", taskId), data => {
              if(data.success) $("#delete-task-name").text(`"${data.task.task_name}"`);
          });
        }

        $("#updateTaskBtn").on("click", function () {
          var form = $("#editTaskForm");
          
          // Client-side due date validation for edit form with proper date parsing
          var dueDateInput = form.find('[name="due_date"]');
          var dueDateValue = dueDateInput.val();
          console.log('üîç Edit Form - Due date input value:', dueDateValue);
          
          if (dueDateValue) {
            var dueDate;
            var today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day for accurate comparison
            
            try {
              // For edit form, dates are usually in YYYY-MM-DD format from HTML5 date input
              if (dueDateValue.includes('-') && dueDateValue.split('-')[0].length === 4) {
                dueDate = new Date(dueDateValue); // YYYY-MM-DD format
              } else {
                // Handle DD-MM-YY format if it appears in edit form
                var parts = dueDateValue.split('-');
                if (parts.length === 3 && parts[2].length === 2) {
                  var day = parseInt(parts[0], 10);
                  var month = parseInt(parts[1], 10) - 1;
                  var year = 2000 + parseInt(parts[2], 10);
                  dueDate = new Date(year, month, day);
                } else {
                  dueDate = new Date(dueDateValue);
                }
              }
              
              if (dueDate && !isNaN(dueDate.getTime()) && dueDate < today) {
                console.log('‚ùå Edit form validation failed: Due date is in the past');
                $("#edit-form-errors").html('<ul><li>Due date cannot be in the past. Please select today\'s date or a future date.</li></ul>').removeClass("d-none");
                return false;
              } else {
                console.log('‚úÖ Edit form validation passed: Due date is valid');
              }
            } catch (e) {
              console.log('‚ö†Ô∏è Edit form validation error:', e);
              // Allow form submission if date parsing fails - let server handle validation
            }
          }
          
          var formData = new FormData(form[0]);
          
          // üîß FIXED: Remove empty file upload to prevent validation errors
          var fileInput = form.find('input[name="upload"]')[0];
          if (fileInput && fileInput.files.length > 0) {
            var file = fileInput.files[0];
            if (file.size === 0 || file.name === '') {
              console.log('üîç Edit Form - Removing empty file from FormData');
              formData.delete('upload');
            }
          }
          
          // Debug: Log form data
          console.log('üîç Edit Form - FormData entries:');
          for (let [key, value] of formData.entries()) {
            console.log(key + ':', value);
          }
          $.ajax({
            url: form.attr("action"),
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            success: function (data) {
              if (data.success) {
                editModal.hide();
                grid.trigger("reloadGrid");
              } else {
                let errorHtml = '<ul>';
                for (const field in data.errors) {
                  errorHtml += `<li>${field}: ${data.errors[field][0]}</li>`;
                }
                errorHtml += '</ul>';
                $("#edit-form-errors").html(errorHtml).removeClass("d-none");
              }
            },
            error: () => $("#edit-form-errors").html("An unexpected error occurred.").removeClass("d-none")
          });
        });

        $("#confirmDeleteBtn").on("click", function () {
          var taskId = $(this).data("task-id");
          $.ajax({
            url: taskDeleteUrl.replace("0", taskId),
            method: "POST",
            headers: { "X-CSRFToken": csrfToken },
            success: (data) => {
              if (data.success) {
                deleteModal.hide();
                grid.trigger("reloadGrid");
              }
            },
          });
        });

        // Prevent form clearing when datepicker is focused
        $(document).on('focus', '#id_due_date', function(e) {
            // Prevent any modal reset events from firing
            e.stopPropagation();
        });

        // Prevent form clearing when datepicker is clicked
        $(document).on('click', '#id_due_date', function(e) {
            // Prevent any modal reset events from firing
            e.stopPropagation();
        });

        // Auto-populate email when employee is selected
        $(document).on('change', '#id_assigned_to', function() {
            const employeeId = $(this).val();
            const emailField = $('#id_email');

            if (employeeId) {
                // Show loading state
                emailField.val('Loading...').prop('readonly', true);

                $.ajax({
                    url: `{% url 'tasks:get_employee_email' 0 %}`.replace('0', employeeId),
                    method: 'GET',
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                    success: function(data) {
                        if (data.success && data.email) {
                            emailField.val(data.email);
                        } else {
                            emailField.val('');
                            console.log('No email found for selected employee');
                        }
                    },
                    error: function() {
                        emailField.val('');
                        console.log('Error fetching employee email');
                    },
                    complete: function() {
                        emailField.prop('readonly', false);
                    }
                });
            } else {
                emailField.val('').prop('readonly', false);
            }
        });

        $("#saveTaskBtn").on("click", function () {
          var form = $("#addTaskForm");
          
          // Client-side due date validation with DD-MM-YY format support
          var dueDateInput = form.find('#id_due_date');
          var dueDateValue = dueDateInput.val();
          console.log('üîç Client validation - Due date input value:', dueDateValue);
          
          if (dueDateValue) {
            var dueDate;
            var today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to start of day for accurate comparison
            
            try {
              // Parse DD-MM-YY format (e.g., 04-10-25)
              var parts = dueDateValue.split('-');
              if (parts.length === 3 && parts[2].length === 2) {
                var day = parseInt(parts[0], 10);
                var month = parseInt(parts[1], 10) - 1; // JavaScript months are 0-indexed
                var year = 2000 + parseInt(parts[2], 10); // Convert YY to YYYY
                dueDate = new Date(year, month, day);
                console.log('üîç Client validation - Parsed date:', dueDate);
              } else {
                // Try direct parsing for other formats
                dueDate = new Date(dueDateValue);
              }
              
              if (dueDate && !isNaN(dueDate.getTime()) && dueDate < today) {
                console.log('‚ùå Client validation failed: Due date is in the past');
                $("#add-form-errors").html('<ul><li>Due date cannot be in the past. Please select today\'s date or a future date.</li></ul>').removeClass("d-none");
                return false;
              } else {
                console.log('‚úÖ Client validation passed: Due date is valid');
              }
            } catch (e) {
              console.log('‚ö†Ô∏è Client validation error:', e);
              // Allow form submission if date parsing fails - let server handle validation
            }
          }
          
          // Get form data and handle date format conversion
          var formData = new FormData(form[0]);
          
          // Check and convert due date format if needed
          var dueDateValue = form.find('#id_due_date').val();
          if (dueDateValue) {
            console.log('Original due date value:', dueDateValue);
            
            // If it's in DD-MM-YY format (like 29-09-25), convert to YYYY-MM-DD
            var dateParts = dueDateValue.split('-');
            if (dateParts.length === 3 && dateParts[2].length === 2) {
              var day = dateParts[0].padStart(2, '0');    // First part is day
              var month = dateParts[1].padStart(2, '0');  // Second part is month
              var year = '20' + dateParts[2];             // Convert YY to 20YY
              var convertedDate = year + '-' + month + '-' + day;  // Format: YYYY-MM-DD
              console.log('Converted due date to:', convertedDate);
              formData.set('due_date', convertedDate);
            }
          }
          
          // Debug: Log form data being sent
          console.log('üìù Form Data Debug:');
          for (let [key, value] of formData.entries()) {
            console.log(key + ': ' + value);
          }

          $.ajax({
            url: form.attr("action"),
            method: "POST",
            data: formData,
            processData: false,
            contentType: false,
            headers: { "X-Requested-With": "XMLHttpRequest" },
            success: function (data) {
              if (data.success) {
                // Hide modal and remove backdrop properly
                addTaskModal.hide();
                
                // Remove any leftover backdrop and modal classes
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open').css('overflow', '');
                $('body').css('padding-right', '');
                
                // Reset form and clear errors
                form.trigger("reset");
                $("#add-form-errors").addClass('d-none').html('');
                
                // Reload the grid
                grid.trigger("reloadGrid");
                
                // Small delay to ensure modal is fully closed before any other actions
                setTimeout(function() {
                  // You can add any additional cleanup here if needed
                }, 300);
                
              } else {
                let errorHtml = '<ul>';
                for (const field in data.errors) {
                  errorHtml += `<li>${field}: ${data.errors[field][0]}</li>`;
                }
                errorHtml += '</ul>';
                $("#add-form-errors").html(errorHtml).removeClass("d-none");
              }
            },
            error: function(xhr, status, error) {
              console.log('Error Status:', status);
              console.log('Error Details:', error);
              console.log('Response Text:', xhr.responseText);
              
              // Try to parse JSON response for form errors
              try {
                const response = JSON.parse(xhr.responseText);
                if (response.errors) {
                  let errorHtml = '<ul>';
                  for (const field in response.errors) {
                    errorHtml += `<li><strong>${field}:</strong> ${response.errors[field][0]}</li>`;
                  }
                  errorHtml += '</ul>';
                  $("#add-form-errors").html(errorHtml).removeClass("d-none");
                } else if (response.error) {
                  $("#add-form-errors").html(`<div>${response.error}</div>`).removeClass("d-none");
                } else {
                  $("#add-form-errors").html('<div>An unexpected error occurred. Please check the console for details.</div>').removeClass("d-none");
                }
              } catch (e) {
                $("#add-form-errors").html('<div>An unexpected error occurred. Please check the console for details.</div>').removeClass("d-none");
              }
            }
          });
        });
      });
    </script>
  </body>
</html>

{% endblock %}